<!DOCTYPE html>
<html>
<head>
    <title>RallyChartGenerator</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('BarCalculator', {
    config: {
        barCalculationType: undefined,
        field: undefined
    },
    
    constructor: function(config) {
        this.initConfig(config);    
    },
    
    prepareChartData: function(store) {
        var categories, seriesData, data;
        if(this.barCalculationType === 'count') {
            data = _.countBy(store.getRange(), function(record) { 
                return record.get(this.field); 
            }, this);
            categories = _.keys(data);
            seriesData = [];
            _.each(data, function(value, key) {
                seriesData.push([key, value]);    
            });
        } else {
            data = _.groupBy(store.getRange(), function(record) {
                return record.get(this.field);
            }, this);
            categories = _.keys(data);
            seriesData = [];
            _.each(data, function(value, key) {
                seriesData.push([key, _.reduce(value, function(total, r) {
                    return total + r.get('PlanEstimate');
                }, 0)]);
            });
        }
        
        return {
            xAxis: {
                categories: categories
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Total fruit consumption'
                },
                stackLabels: {
                    enabled: true,
                    style: {
                        fontWeight: 'bold',
                        color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                    }
                }
            },
            series: [
                {
                    type: 'column',
                    data: seriesData
                }
            ]
        };
    }
});
                
Ext.define('BarChart', {
    extend: 'Ext.Container',
    alias: 'widget.barchart',
    config: {
        types: [],
        context: undefined
    },
    
    layout: {
        type: 'hbox',
        align: 'stretch'
    },
    
    initComponent: function() {
        this.callParent(arguments);
        Rally.data.ModelFactory.getModels({
            types: this.types
        }).then({
            success: this._addControls,
            scope: this
        }).then({
            success: this._getData,
            scope: this
        });
    },
    
    refresh: function (config) {
        var me = this;
        Ext.apply(this, config);
        if(this.down('rallychart')) {
            this.down('rallychart').destroy();
        }
        
        //this._showChart();


        Rally.data.ModelFactory.getModels({
            types: this.types
        }).then({
            success: this._getData,
            scope: this
        }).always(function () {
            me.setLoading(false);
        });

        this.down('#filterSummary').update(this._getFilterSummaryHtml());
    },

    _getData: function (models) {
        var deferred = Ext.create('Deft.Deferred');

        console.log('Getting data for bar chart', models);

        var store = Ext.create('Rally.data.wsapi.artifact.Store', {
            models: models,
            //models: this.types,
            context: this.getContext().getDataContext(),
            limit: Infinity,
            filters: this.filters,
            autoLoad: true,
            listeners: {
                scope: this,
                load: this._processData
            }
        });
        console.log('Call to WSAPI store complete.');

        return deferred;

        //storeType: 'Rally.data.wsapi.artifact.Store',
        //storeConfig: {
        //    models: this.types,
        //    context: this.getContext().getDataContext(),
        //    limit: Infinity,
        //    filters: this.filters
        //}
    },

    _processData: function (store, records, successful) {

        console.log('returned store: ', store);

        var barCalculationType = this.down('radiogroup').getValue().barCalculationType;
        var field = this.down('#barXaxis').getValue();
        
        // Skip over populating chart if nothing is selected in X-axis
        if (field) {
            var categories, seriesData, data;
            if (barCalculationType === 'count') {
                data = _.countBy(store.getRange(), function (record) {
                    return record.get(field);
                }, this);
                categories = _.keys(data);
                seriesData = [];
                _.each(data, function (value, key) {
                    seriesData.push([key, value]);
                });
            } else {
                data = _.groupBy(store.getRange(), function (record) {
                    return record.get(field);
                }, this);
                categories = _.keys(data);
                seriesData = [];
                _.each(data, function (value, key) {
                    seriesData.push([key, _.reduce(value, function (total, r) {
                        return total + r.get('PlanEstimate');
                    }, 0)]);
                });
            }
           
            var graph = {
                xAxis: {
                    categories: categories
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'I have the text I am looking for'
                    },
                    stackLabels: {
                        enabled: true,
                        style: {
                            fontWeight: 'bold',
                            color: 'gray' //||(Highcharts.theme && Highcharts.theme.textColor)
                        }
                    }
                },
                series: [
                    {
                        name: 'Schedule State',
                        type: 'column',
                        data: seriesData
                    }
                ]
            };

            this._showChart(graph);
        }

    },
    
    _addControls: function(models) {
        var wiTypes = _.values(models);
        var validFields = this._getValidFields(wiTypes);
        
        this.add([
            {
                xtype: 'component',
                flex: 1
            }, 
            {
                xtype: 'container',
                items: [{
                    width: 250,
                    margin: '100px 0 0 0',
                    xtype: 'rallycombobox',
                    itemId: 'barXaxis',
                    fieldLabel: 'X-axis:',
                    labelAlign: 'top',
                    labelWidth: 60,
                    displayField: 'displayName',
                    valueField: 'name',
                    editable: false,
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('barXaxis'),
                    store: Ext.create('Ext.data.Store', {
                        fields: ['name', 'displayName'],
                        data: _.map(validFields, function(field) {
                            return {
                                displayName: Rally.ui.renderer.FieldDisplayNameRenderer.getDisplayName(field),
                                name: field.name
                            };
                        })
                    }),
                    applyState: function(state) {
                        //hack alert
                        //this function is necessary to work around a defect in the sdk
                        Rally.ui.combobox.ComboBox.superclass.applyState.call(this, state);
                    },
                    listeners: {
                        select: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                },
                {
                    width: 250,
                    margin: '100px 0 0 0',
                    xtype: 'rallycombobox',
                    itemId: 'barSlicer',
                    fieldLabel: 'Bar Slicer:',
                    labelAlign: 'top',
                    labelWidth: 60,
                    displayField: 'displayName',
                    valueField: 'name',
                    editable: false,
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('barSlicer'),
                    store: Ext.create('Ext.data.Store', {
                        fields: ['name', 'displayName'],
                        data: _.map(validFields, function(field) {
                            return {
                                displayName: Rally.ui.renderer.FieldDisplayNameRenderer.getDisplayName(field),
                                name: field.name
                            };
                        })
                    }),
                    applyState: function(state) {
                        //hack alert
                        //this function is necessary to work around a defect in the sdk
                        Rally.ui.combobox.ComboBox.superclass.applyState.call(this, state);
                    },
                    listeners: {
                        select: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                },
                {
                    xtype: 'radiogroup',
                    fieldLabel: 'Y-axis selection',
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('barCalculationType'),
                    columns: 1,
                    items: [
                        { boxLabel: 'Plan Estimate Sum', name: 'barCalculationType', inputValue: 'sum' },
                        { boxLabel: 'Work Item Count', name: 'barCalculationType', inputValue: 'count', checked: true}
                    ],
                     listeners: {
                        change: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                }]
            },
            {
                xtype: 'component',
                width: 250,
                itemId: 'filterSummary',
                margin: '100px 0 0 0',
                html: this._getFilterSummaryHtml()
            },
            {
                xtype: 'component',
                flex: 1
            }
        ]);
        
        return models;
        //if (graph)
        //    this._showChart(graph);
    },
    
    _getFilterSummaryHtml: function() {
        return Ext.String.format('<ul>{0}</ul>', _.map(this.filters, function(filter) {
            return Ext.String.format('<li>{0}</li>', filter.toString());
        }).join(''));
    },
    
    _showChart: function (graph) {

        console.log('Here is the graph: ', graph);
        console.log('X categories: ', graph.xAxis.categories);

       this.insert(2, {
            xtype: 'rallychart',
            flex: 10,
            //storeType: 'Rally.data.wsapi.artifact.Store',
            //storeConfig: {
            //    models: this.types,
            //    context: this.getContext().getDataContext(),
            //    limit: Infinity,
            //    filters: this.filters
            //},
            //calculatorType: 'BarCalculator',
            //calculatorConfig: {
            //    barCalculationType: this.down('radiogroup').getValue().barCalculationType,
            //    field: this.down('#barXaxis').getValue()
            //},
            chartData: graph,
            chartConfig: {
                chart: { type: 'column' },
                title: { 
                    text: Ext.String.format('{0} - {1}', 
                        this.getContext().getProject().Name,
                        _.map(this.types, function(type) {
                            return Rally.util.TypeInfo.getTypeInfoByName(type).typeName; 
                        }).join(', '))
                },
                xAxis: { categories: graph.xAxis.categories },
                yAxis: {
                    min: 0,
                    title: {
                        text: this.down('radiogroup').getValue().barCalculationType
                    },
                    stackLabels: {
                        enabled: true,
                        style: {
                            fontWeight: 'bold',
                            color: 'gray'
                        }
                    }
                },
                plotOptions: {
                    column: {
                        stacking: 'normal',
                        dataLabels: {
                            enabled: true,
                            color: 'white', //(Highcharts.theme && Highcharts.theme.dataLabelsColor)
                            style: {
                                textShadow: '0 0 3px black'
                            }
                        }
                    }
                }
            }
        });  
    },
    
    _getValidFields: function(models) {
        this.model = this._getArtifactModel(models);
        var fields = _(this.model.getFields()).filter(this._shouldShowField, this).sortBy('displayName').value();
        return _.filter(fields, function(field) {
            return _.every(models, function(model) {
                return model.hasField(field.name);
            });
        }, this);
    },

    _getArtifactModel: function(models) {
        return Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(models, this.getContext());
    },

    _shouldShowField: function(field) {
        return !field.hidden && field.attributeDefinition && field.getType() !== 'collection';
    }
});
                Ext.define('PieCalculator', {
    config: {
        calculationType: undefined,
        field: undefined
    },
    
    constructor: function(config) {
        this.initConfig(config);    
    },
    
    prepareChartData: function(store) {
        var categories, seriesData, data;
        if(this.calculationType === 'count') {
            data = _.countBy(store.getRange(), function(record) { 
                return record.get(this.field); 
            }, this);
            categories = _.keys(data);
            seriesData = [];
            _.each(data, function(value, key) {
                seriesData.push([key, value]);    
            });
        } else {
            data = _.groupBy(store.getRange(), function(record) {
                return record.get(this.field);
            }, this);
            categories = _.keys(data);
            seriesData = [];
            _.each(data, function(value, key) {
                seriesData.push([key, _.reduce(value, function(total, r) {
                    return total + r.get('PlanEstimate');
                }, 0)]);
            });
        }
        
        return {
            categories: categories,
            series: [
                {
                    type: 'pie',
                    data: seriesData
                }
            ]
        };
    }
});
                
Ext.define('PieChart', {
    extend: 'Ext.Container',
    alias: 'widget.piechart',
    config: {
        types: [],
        context: undefined,
        filters: []
    },
    
    layout: {
        type: 'hbox',
        align: 'stretch'
    },
    
    initComponent: function() {
        this.callParent(arguments);
        Rally.data.ModelFactory.getModels({
            types: this.types
        }).then({
            success: this._addControls,
            scope: this
        });
    },
    
    refresh: function(config) {
        Ext.apply(this, config);
        if(this.down('rallychart')) {
            this.down('rallychart').destroy();
        }
        this._showChart();
        this.down('#filterSummary').update(this._getFilterSummaryHtml());
    },
    
    _addControls: function(models) {
        var wiTypes = _.values(models);
        var validFields = this._getValidFields(wiTypes);
        
        this.add([
            {
                xtype: 'component',
                flex: 1
            }, 
            {
                xtype: 'container',
                items: [{
                    width: 250,
                    margin: '100px 0 0 0',
                    xtype: 'rallycombobox',
                    itemId: 'aggregationField',
                    fieldLabel: 'Slice By:',
                    labelAlign: 'top',
                    labelWidth: 60,
                    displayField: 'displayName',
                    valueField: 'name',
                    editable: false,
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('aggregationField'),
                    store: Ext.create('Ext.data.Store', {
                        fields: ['name', 'displayName'],
                        data: _.map(validFields, function(field) {
                            return {
                                displayName: Rally.ui.renderer.FieldDisplayNameRenderer.getDisplayName(field),
                                name: field.name
                            };
                        })
                    }),
                    applyState: function(state) {
                        //hack alert
                        //this function is necessary to work around a defect in the sdk
                        Rally.ui.combobox.ComboBox.superclass.applyState.call(this, state);
                    },
                    listeners: {
                        select: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                }, 
                {
                    xtype: 'radiogroup',
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('calculationType'),
                    columns: 1,
                    items: [
                        { boxLabel: 'Sum', name: 'calculationType', inputValue: 'sum' },
                        { boxLabel: 'Count', name: 'calculationType', inputValue: 'count', checked: true}
                    ],
                     listeners: {
                        change: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                }]
            },
            {
                xtype: 'component',
                width: 250,
                itemId: 'filterSummary',
                margin: '100px 0 0 0',
                html: this._getFilterSummaryHtml()
            },
            {
                xtype: 'component',
                flex: 1
            }
        ]);
        
       this._showChart();
    },
    
    _getFilterSummaryHtml: function() {
        return Ext.String.format('<ul>{0}</ul>', _.map(this.filters, function(filter) {
            return Ext.String.format('<li>{0}</li>', filter.toString());
        }).join('')) || 'Showing all data';
    },
    
    _showChart: function() {
       this.insert(2, {
            xtype: 'rallychart',
            flex: 10,
            storeType: 'Rally.data.wsapi.artifact.Store',
            storeConfig: {
                models: this.types,
                context: this.getContext().getDataContext(),
                limit: Infinity,
                filters: this.filters,
                fetch: ['PlanEstimate', this.down('#aggregationField').getValue()]
            },
            calculatorType: 'PieCalculator',
            calculatorConfig: {
                calculationType: this.down('radiogroup').getValue().calculationType,
                field: this.down('#aggregationField').getValue()
            },
            chartConfig: {
                chart: { type: 'pie' },
                title: { 
                    text: Ext.String.format('{0} - {1}', 
                        this.getContext().getProject().Name,
                        _.map(this.types, function(type) {
                            return Rally.util.TypeInfo.getTypeInfoByName(type).typeName; 
                        }).join(', '))
                },
                plotOptions: {
                    pie: {
                        minSize: 500,
                        dataLabels: {
                            distance: -30,
                            color: 'white'
                        }
                    }
                }
            }
        });  
    },
    
    _getValidFields: function(models) {
        this.model = this._getArtifactModel(models);
        var fields = _(this.model.getFields()).filter(this._shouldShowField, this).sortBy('displayName').value();
        return _.filter(fields, function(field) {
            return _.every(models, function(model) {
                return model.hasField(field.name);
            });
        }, this);
    },

    _getArtifactModel: function(models) {
        return Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(models, this.getContext());
    },

    _shouldShowField: function(field) {
        return !field.hidden && field.attributeDefinition && field.getType() !== 'collection';
    }
});
                Ext.define('CfdCalculator', {
   extend: 'Rally.data.lookback.calculator.TimeSeriesCalculator',
    config: {
        stateFieldName: '',
        stateFieldValues: [],
        calculationType: ''
    },

    constructor: function(config) {
        this.initConfig(config);
        this.callParent(arguments);
    },

    getMetrics: function() {
        if(this.getCalculationType() === 'count') {
            return _.map(this.getStateFieldValues(), function(stateFieldValue) {
                return  {
                    as: stateFieldValue,
                    groupByField: this.getStateFieldName(),
                    allowedValues: [stateFieldValue],
                    f: 'groupByCount',
                    display: 'area'
                };
            }, this);
        } else {
            return _.map(this.getStateFieldValues(), function(stateFieldValue) {
                return  {
                    as: stateFieldValue,
                    groupByField: this.getStateFieldName(),
                    field: 'PlanEstimate',
                    allowedValues: [stateFieldValue],
                    f: 'groupBySum',
                    display: 'area'
                };
            }, this);
        }
    }
});
                
Ext.define('CfdChart', {
    extend: 'Ext.Container',
    alias: 'widget.cfdchart',
    config: {
        types: [],
        context: undefined,
        filters: []
    },
    
    layout: {
        type: 'hbox',
        align: 'stretch'
    },
    
    initComponent: function() {
        this.callParent(arguments);
        Rally.data.ModelFactory.getModels({
            types: this.types
        }).then({
            success: this._addControls,
            scope: this
        });
    },
    
    refresh: function(config) {
        Ext.apply(this, config);
        if(this.down('rallychart')) {
            this.down('rallychart').destroy();
        }
        this._showChart();
        this.down('#filterSummary').update(this._getFilterSummaryHtml());
    },
    
    _addControls: function(models) {
        var wiTypes = _.values(models);
        var validFields = this._getValidFields(wiTypes);
        
        this.add([
            {
                xtype: 'component',
                flex: 1
            }, 
            {
                xtype: 'container',
                items: [{
                    width: 250,
                    margin: '100px 0 0 0',
                    xtype: 'rallycombobox',
                    itemId: 'aggregationField',
                    fieldLabel: 'Flow by:',
                    labelAlign: 'top',
                    labelWidth: 60,
                    displayField: 'displayName',
                    valueField: 'name',
                    editable: false,
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('aggregationField'),
                    store: Ext.create('Ext.data.Store', {
                        fields: ['name', 'displayName'],
                        data: _.map(validFields, function(field) {
                            return {
                                displayName: Rally.ui.renderer.FieldDisplayNameRenderer.getDisplayName(field),
                                name: field.name
                            };
                        })
                    }),
                    applyState: function(state) {
                        //hack alert
                        //this function is necessary to work around a defect in the sdk
                        Rally.ui.combobox.ComboBox.superclass.applyState.call(this, state);
                    },
                    listeners: {
                        select: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                }, 
                {
                    xtype: 'radiogroup',
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('calculationType'),
                    columns: 1,
                    items: [
                        { boxLabel: 'Sum', name: 'calculationType', inputValue: 'sum' },
                        { boxLabel: 'Count', name: 'calculationType', inputValue: 'count', checked: true}
                    ],
                     listeners: {
                        change: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                }]
            },
            {
                xtype: 'component',
                width: 250,
                itemId: 'filterSummary',
                margin: '100px 0 0 0',
                html: this._getFilterSummaryHtml()
            },
            {
                xtype: 'component',
                flex: 1
            }
        ]);
        
       this._showChart();
    },
    
    _getFilterSummaryHtml: function() {
        return Ext.String.format('<ul>{0}</ul>', _.map(this.filters, function(filter) {
            return Ext.String.format('<li>{0}</li>', filter.toString());
        }).join('')) || 'Showing all data';
    },

    _getStoreConfig: function() {
        var storeConfig = {
            find: {
                _TypeHierarchy: { '$in' : _.map(this.model.getArtifactComponentModels(), function(m) {
                    var typeInfo = Rally.util.TypeInfo.getTypeInfoByName(m.typePath);
                    return typeInfo.schemaType || ''; //todo pi's?
                }) },
                Children: null,
                _ProjectHierarchy: this.getContext().getProject().ObjectID,
                _ValidFrom: {
                    //TODO: replace default date filter?
                    '$gt': Rally.util.DateTime.toIsoString(Rally.util.DateTime.add(new Date(), 'day', -90)) 
                }
            },
            fetch: ['PlanEstimate', this.down('#aggregationField').getValue()],
            hydrate: [this.down('#aggregationField').getValue()],
            sort: {
                _ValidFrom: 1
            },
            context: this.getContext().getDataContext(),
            limit: Infinity
        };

        if(this.filters.length && this.filters[0].property === 'Milestones') {
            var milestoneRef = this.filters[0].value;
            var milestoneOid = Rally.util.Ref.getOidFromRef(milestoneRef);
            delete storeConfig.find._ProjectHierarchy;
            return Rally.data.ModelFactory.getModel({
                type: Rally.util.Ref.getTypeFromRef(milestoneRef)
            }).then({
                success: function(model) {
                    return model.load(milestoneOid, {
                        fetch: ['TargetDate', 'Artifacts']
                    }).then({
                        success: function(record) {
                            //todo set valid from date based on actual start dates of work
                            return record.getCollection('Artifacts').load({
                                limit: Infinity
                            }).then({
                                success: function(artifacts) {
                                    storeConfig.find._ItemHierarchy = {'$in': _.invoke(artifacts, 'getId')};
                                    return storeConfig;
                                },
                                scope: this
                            });
                        },
                        scope: this
                    });
                },
                scope: this
            });
        }

        return Deft.Promise.when(storeConfig);
    },

    _getAggregationFieldValues: function() {
        return this.model.getField(this.down('#aggregationField').getValue()).getAllowedValueStore().load();
    },
    
    _showChart: function() {
        Deft.Promise.all([
            this._getStoreConfig(), 
            this._getAggregationFieldValues()]
        ).then({
            success: function(results) {
                var storeConfig = results[0],
                    stateFieldValues = _.invoke(results[1], 'get', 'StringValue');

                this.insert(2, {
                    xtype: 'rallychart',
                    flex: 10,
                    storeType: 'Rally.data.lookback.SnapshotStore',
                    storeConfig: storeConfig,
                    calculatorType: 'CfdCalculator',
                    calculatorConfig: {
                        calculationType: this.down('radiogroup').getValue().calculationType,
                        stateFieldName: this.down('#aggregationField').getValue(),
                        stateFieldValues: stateFieldValues
                    },
                    chartConfig: {
                        chart: {
                            zoomType: 'xy'
                        },
                        title: {
                            text: Ext.String.format('{0} Cumulative Flow - {1}', 
                                this.getContext().getProject().Name,
                                _.map(this.types, function(type) {
                                    return Rally.util.TypeInfo.getTypeInfoByName(type).typeName; 
                                }).join(', '))
                        },
                        xAxis: {
                            tickmarkPlacement: 'on',
                            tickInterval: 20,
                            title: {
                                text: 'Date'
                            }
                        },
                        yAxis: [
                            {
                                title: {
                                    text: this.down('radiogroup').getValue().calculationType === 'count' ? 
                                        'Count' : this.getContext().getWorkspace().WorkspaceConfiguration.IterationEstimateUnitName
                                }
                            }
                        ],
                        plotOptions: {
                            series: {
                                marker: {
                                    enabled: false
                                }
                            },
                            area: {
                                stacking: 'normal'
                            }
                        }
                    }
                });
            },
            scope: this
        });  
    },
    
    _getValidFields: function(models) {
        this.model = this._getArtifactModel(models);
        var fields = _(this.model.getFields()).filter(this._shouldShowField, this).sortBy('displayName').value();
        return _.filter(fields, function(field) {
            return _.every(models, function(model) {
                return model.hasField(field.name);
            });
        }, this);
    },

    _getArtifactModel: function(models) {
        return Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(models, this.getContext());
    },

    _shouldShowField: function(field) {
        return !field.hidden && field.attributeDefinition && 
        field.getType() !== 'collection' && field.hasAllowedValues();
    }
});
                Ext.define('BurnCalculator', {
   extend: 'Rally.data.lookback.calculator.TimeSeriesCalculator',
    config: {
        completedStateNames: [],
        stateField: '',
        calculationType: ''
    },

    constructor: function(config) {
        this.initConfig(config);
        this.callParent(arguments);
    },

    getDerivedFieldsOnInput: function() {
        var completedStateNames = this.getCompletedStateNames(),
            stateField = this.getStateField(),
            calculationType = this.getCalculationType();
        return [
            {
                "as": "Planned",
                "f": function(snapshot) {
                    if(calculationType === 'count') {
                        return 1;
                    }

                    return snapshot.PlanEstimate || 0;
                }
            },
            {
                "as": "PlannedCompleted",
                "f": function(snapshot) {
                    if (_.contains(completedStateNames, snapshot[stateField])) {
                        return calculationType === 'count' ? 1 :
                            (snapshot.PlanEstimate || 0);
                    }

                    return 0;
                }
            }
        ];
    },

    getMetrics: function() {
        return [
            {
                "field": "Planned",
                "as": "Planned",
                "display": "line",
                "f": "sum"
            },
            {
                "field": "PlannedCompleted",
                "as": "Completed",
                "f": "sum",
                "display": "column"
            }
        ];
    }
});
                
Ext.define('BurnChart', {
    extend: 'Ext.Container',
    alias: 'widget.burnchart',
    config: {
        types: [],
        context: undefined,
        filters: []
    },
    
    layout: {
        type: 'hbox',
        align: 'stretch'
    },
    
    initComponent: function() {
        this.callParent(arguments);
        Rally.data.ModelFactory.getModels({
            types: this.types
        }).then({
            success: this._addControls,
            scope: this
        });
    },
    
    refresh: function(config) {
        Ext.apply(this, config);
        if(this.down('rallychart')) {
            this.down('rallychart').destroy();
        }
        this._showChart();
        this.down('#filterSummary').update(this._getFilterSummaryHtml());
    },
    
    _addControls: function(models) {
        var wiTypes = _.values(models);
        var validFields = this._getValidFields(wiTypes);
        
        this.add([
            {
                xtype: 'component',
                flex: 1
            }, 
            {
                xtype: 'container',
                items: [{
                    width: 250,
                    margin: '100px 0 0 0',
                    xtype: 'rallycombobox',
                    itemId: 'aggregationField',
                    fieldLabel: 'Burn by:',
                    labelAlign: 'top',
                    labelWidth: 60,
                    displayField: 'displayName',
                    valueField: 'name',
                    editable: false,
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('aggregationField'),
                    store: Ext.create('Ext.data.Store', {
                        fields: ['name', 'displayName'],
                        data: _.map(validFields, function(field) {
                            return {
                                displayName: Rally.ui.renderer.FieldDisplayNameRenderer.getDisplayName(field),
                                name: field.name
                            };
                        })
                    }),
                    applyState: function(state) {
                        //hack alert
                        //this function is necessary to work around a defect in the sdk
                        Rally.ui.combobox.ComboBox.superclass.applyState.call(this, state);
                    },
                    listeners: {
                        select: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                }, 
                {
                    xtype: 'radiogroup',
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('calculationType'),
                    columns: 1,
                    items: [
                        { boxLabel: 'Sum', name: 'calculationType', inputValue: 'sum' },
                        { boxLabel: 'Count', name: 'calculationType', inputValue: 'count', checked: true}
                    ],
                     listeners: {
                        change: function() {
                            this.refresh();
                        },
                        scope: this
                    }
                }]
            },
            {
                xtype: 'component',
                width: 250,
                itemId: 'filterSummary',
                margin: '100px 0 0 0',
                html: this._getFilterSummaryHtml()
            },
            {
                xtype: 'component',
                flex: 1
            }
        ]);
        
       this._showChart();
    },
    
    _getFilterSummaryHtml: function() {
        return Ext.String.format('<ul>{0}</ul>', _.map(this.filters, function(filter) {
            return Ext.String.format('<li>{0}</li>', filter.toString());
        }).join('')) || 'Showing all data';
    },

    _getStoreConfig: function() {
        var storeConfig = {
            find: {
                _TypeHierarchy: { '$in' : _.map(this.model.getArtifactComponentModels(), function(m) {
                    var typeInfo = Rally.util.TypeInfo.getTypeInfoByName(m.typePath);
                    return typeInfo.schemaType || ''; //todo pi's?
                }) },
                Children: null,
                _ProjectHierarchy: this.getContext().getProject().ObjectID,
                _ValidFrom: {
                    //TODO: replace default date filter?
                    '$gt': Rally.util.DateTime.toIsoString(Rally.util.DateTime.add(new Date(), 'day', -30)) 
                }
            },
            fetch: ['PlanEstimate', this.down('#aggregationField').getValue()],
            hydrate: [this.down('#aggregationField').getValue()],
            sort: {
                _ValidFrom: 1
            },
            context: this.getContext().getDataContext(),
            limit: Infinity
        };
        
        if(this.filters.length && this.filters[0].property === 'Feature') {
            var featureRef = this.filters[0].value;
            var featureOid = Rally.util.Ref.getOidFromRef(featureRef);
            delete storeConfig.find._ProjectHierarchy;
            storeConfig.find._ItemHierarchy = featureOid;
            return Rally.data.ModelFactory.getModel({
                type: Rally.util.Ref.getTypeFromRef(featureRef)
            }).then({
                success: function(model) {
                    return model.load(featureOid, {
                        fetch: ['ActualStartDate']
                    }).then({
                        success: function(record) {
                            storeConfig.find._ValidFrom.$gt = Rally.util.DateTime.toIsoString(record.get('ActualStartDate'));
                            return storeConfig;
                        },
                        scope: this
                    });
                },
                scope: this
            });
        } 

        return Deft.Promise.when(storeConfig);
    },

    _getAggregationFieldValues: function() {
        return this.model.getField(this.down('#aggregationField').getValue()).getAllowedValueStore().load();
    },
    
    _showChart: function() {
        Deft.Promise.all([
            this._getStoreConfig(), 
            this._getAggregationFieldValues()]
        ).then({
            success: function(results) {
                var storeConfig = results[0],
                    stateFieldValues = _.invoke(results[1], 'get', 'StringValue');

                this.insert(2, {
                    xtype: 'rallychart',
                    flex: 10,
                    storeType: 'Rally.data.lookback.SnapshotStore',
                    storeConfig: storeConfig,
                    calculatorType: 'BurnCalculator',
                    calculatorConfig: {
                        calculationType: this.down('radiogroup').getValue().calculationType,
                        completedStateNames: ['Accepted', 'Released'], //TODO: configure
                        stateField: this.down('#aggregationField').getValue()
                    },
                    chartConfig: {
                        chart: {
                            zoomType: 'xy'
                        },
                        title: {
                            text: Ext.String.format('{0} Burn Up - {1}', 
                                this.getContext().getProject().Name,
                                _.map(this.types, function(type) {
                                    return Rally.util.TypeInfo.getTypeInfoByName(type).typeName; 
                                }).join(', '))
                        },
                        xAxis: {
                            categories: [],
                            tickmarkPlacement: 'on',
                            tickInterval: 5,
                            title: {
                                text: 'Date',
                                margin: 10
                            }
                        },
                        yAxis: [
                            {
                               title: {
                                    text: this.down('radiogroup').getValue().calculationType === 'count' ? 
                                        'Count' : this.getContext().getWorkspace().WorkspaceConfiguration.IterationEstimateUnitName
                                }
                            }
                        ],
                        tooltip: {
                            formatter: function() {
                                return '' + this.x + '<br />' + this.series.name + ': ' + this.y;
                            }
                        },
                        plotOptions: {
                            series: {
                                marker: {
                                    enabled: false,
                                    states: {
                                        hover: {
                                            enabled: true
                                        }
                                    }
                                },
                                groupPadding: 0.01
                            },
                            column: {
                                stacking: null,
                                shadow: false
                            }
                        }
                    }
                });
            },
            scope: this
        });  
    },
    
    _getValidFields: function(models) {
        this.model = this._getArtifactModel(models);
        var fields = _(this.model.getFields()).filter(this._shouldShowField, this).sortBy('displayName').value();
        return _.filter(fields, function(field) {
            return _.every(models, function(model) {
                return model.hasField(field.name);
            });
        }, this);
    },

    _getArtifactModel: function(models) {
        return Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(models, this.getContext());
    },

    _shouldShowField: function(field) {
        return !field.hidden && field.attributeDefinition && 
        field.getType() !== 'collection' && field.hasAllowedValues();
    }
});
                Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    
    layout: {
        type: 'vbox',
        align: 'stretch'
    },
    
    launch: function() {
        this._getTypes().then({
            success: this._addControls,
            scope: this
        });
    },
    
    _addControls: function(types) {
        this.add([
            {
                xtype: 'container',
                layout: 'hbox',
                height: 30,
                margin: 10,
                items: [{
                    xtype: 'rallycustomfilterbutton',
                    whiteListFields: ['Milestones'],
                    context: this.getContext(),
                    modelNames: types,
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('filters'),
                    listeners: {
                       customfilter: this._onFilterButtonStateAvailable,
                       scope: this
                    },
                    toolTipConfig: {
                        html: 'Filter',
                        anchor: 'top',
                        mouseOffset: [-9, -2]
                    }
                }, 
                {
                    xtype: 'component',
                    flex: 1
                },
                {
                    xtype: 'rallycombobox',
                    itemId: 'chartType',
                    fieldLabel: 'Chart Type:',
                    labelAlign: 'Left',
                    displayField: 'name',
                    valueField: 'value',
                    editable: false,
                    stateful: true,
                    labelWidth: 60,
                    stateId: this.getContext().getScopedStateId('chartType'),
                    store: Ext.create('Ext.data.Store', {
                        fields: ['name', 'value'],
                        data: [
                            { name: 'Pie', value: 'pie' },
                            { name: 'Bar', value: 'bar' },
                            { name: 'Cumulative Flow', value: 'cfd'},
                            { name: 'Burn', value: 'burn'}
                        ]
                    }),
                     applyState: function(state) {
                        //hack alert
                        //this function is necessary to work around a defect in the sdk
                        Rally.ui.combobox.ComboBox.superclass.applyState.call(this, state);
                    },
                    listeners: {
                        select: function(combo, records){
                            this._createChartConfigSection(combo, records);
                        },
                        scope: this
                    }
                }]
            },
            { xtype: 'container', itemId: 'chart_config_box', flex: 1, layout: 'fit'}
        ]);
    },
    
    _getTypes: function() {
         return Ext.create('Rally.data.wsapi.Store', {
            model: 'TypeDefinition',
            sorters: [
                {
                    property: 'Name'
                }
            ],
            fetch: ['DisplayName', 'ElementName', 'TypePath', 'Parent'],
            filters: [
                {
                    property: 'Creatable',
                    value: true
                }
            ],
            remoteSort: false,
            remoteFilter: true
        }).load().then({
            success: function(records) {
                var types = _.filter(records, function(record) {
                    var parent = record.get('Parent'),
                        parentName = parent.ElementName;
                    return _.contains(['Artifact', 'SchedulableArtifact', 'Requirement', 'PortfolioItem'], parentName);
                });
                var displayNames = _.map(types, function(type) { 
                    return type.get('TypePath');
                });
                displayNames.sort();
                return displayNames;
            }
        });
    },
    
    _onFilterButtonStateAvailable: function() {
        this._createChart(this.down('#chartType').getValue());
    },
    
    _createChartConfigSection: function(comboBox, selectedValue) {
        this.down('#chart_config_box').removeAll();
        delete this.chart;
        var selectedChartType = selectedValue[0].get('value');
        this._createChart(selectedChartType);
    },
    
    _createChart: function(type) {
        var filterButton = this.down('rallycustomfilterbutton'),
            config = {
                types: filterButton.getTypes(),
                filters: filterButton.getFilters()
            };
        if(!this.chart) {
            this.down('#chart_config_box').removeAll();
            this.chart = this.down('#chart_config_box').add(Ext.apply({
                xtype: type + 'chart',
                context: this.getContext()
            }, config));  
        } else {
            this.chart.refresh(config);
        }
    }
});


            Rally.launchApp('CustomApp', {
                name:"RallyChartGenerator",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}

    </style>
</head>
<body>
</body>
</html>
