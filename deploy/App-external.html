<!DOCTYPE html>
<html>
<head>
    <title>RallyChartGenerator</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("PieCalculator",{config:{calculationType:void 0,field:void 0},constructor:function(config){this.initConfig(config)},prepareChartData:function(store){var categories,seriesData,data;return"count"===this.calculationType?(data=_.countBy(store.getRange(),function(record){return record.get(this.field)},this),categories=_.keys(data),seriesData=[],_.each(data,function(value,key){seriesData.push([key,value])}),console.log(seriesData)):(data=_.groupBy(store.getRange(),function(record){return record.get(this.field)},this),categories=_.keys(data),seriesData=[],_.each(data,function(value,key){seriesData.push([key,_.reduce(value,function(total,r){return total+r.get("PlanEstimate")},0)])}),console.log(seriesData)),{categories:categories,series:[{type:"pie",data:seriesData}]}}});
                Ext.define("PieChart",{extend:"Ext.Container",alias:"widget.piechart",config:{types:[],context:void 0},layout:{type:"hbox",align:"stretch"},initComponent:function(){this.callParent(arguments),Rally.data.ModelFactory.getModels({types:this.types}).then({success:this._addControls,scope:this})},refresh:function(config){Ext.apply(this,config),this.down("rallychart")&&this.down("rallychart").destroy(),this._showChart(),this.down("#filterSummary").update(this._getFilterSummaryHtml())},_addControls:function(models){var wiTypes=_.values(models),validFields=this._getValidFields(wiTypes);this.add([{xtype:"component",flex:1},{xtype:"container",items:[{width:250,margin:"100px 0 0 0",xtype:"rallycombobox",itemId:"aggregationField",fieldLabel:"Slice By:",labelAlign:"top",labelWidth:60,displayField:"displayName",valueField:"name",editable:!1,stateful:!0,stateId:this.getContext().getScopedStateId("aggregationField"),store:Ext.create("Ext.data.Store",{fields:["name","displayName"],data:_.map(validFields,function(field){return{displayName:Rally.ui.renderer.FieldDisplayNameRenderer.getDisplayName(field),name:field.name}})}),applyState:function(state){Rally.ui.combobox.ComboBox.superclass.applyState.call(this,state)},listeners:{select:function(){this.refresh()},scope:this}},{xtype:"radiogroup",stateful:!0,stateId:this.getContext().getScopedStateId("calculationType"),columns:1,items:[{boxLabel:"Sum",name:"calculationType",inputValue:"sum"},{boxLabel:"Count",name:"calculationType",inputValue:"count",checked:!0}],listeners:{change:function(){this.refresh()},scope:this}}]},{xtype:"component",width:250,itemId:"filterSummary",margin:"100px 0 0 0",html:this._getFilterSummaryHtml()},{xtype:"component",flex:1}]),this._showChart()},_getFilterSummaryHtml:function(){return Ext.String.format("<ul>{0}</ul>",_.map(this.filters,function(filter){return Ext.String.format("<li>{0}</li>",""+filter)}).join(""))},_showChart:function(){this.insert(2,{xtype:"rallychart",flex:1,storeType:"Rally.data.wsapi.artifact.Store",storeConfig:{models:this.types,context:this.getContext().getDataContext(),limit:1/0,filters:this.filters},calculatorType:"PieCalculator",calculatorConfig:{calculationType:this.down("radiogroup").getValue().calculationType,field:this.down("#aggregationField").getValue()},chartConfig:{chart:{type:"pie"},title:{text:Ext.String.format("{0} - {1}",this.getContext().getProject().Name,_.map(this.types,function(type){return Rally.util.TypeInfo.getTypeInfoByName(type).typeName}).join(", "))},plotOptions:{pie:{minSize:500,dataLabels:{distance:-30,color:"white"}}}}})},_getValidFields:function(models){this.model=this._getArtifactModel(models);var fields=_(this.model.getFields()).filter(this._shouldShowField,this).sortBy("displayName").value();return _.filter(fields,function(field){return _.every(models,function(model){return model.hasField(field.name)})},this)},_getArtifactModel:function(models){return Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(models,this.getContext())},_shouldShowField:function(field){return!field.hidden&&field.attributeDefinition&&"collection"!==field.getType()}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch"},launch:function(){this._getTypes().then({success:this._addControls,scope:this})},_addControls:function(types){this.add([{xtype:"container",layout:"hbox",height:30,margin:10,items:[{xtype:"rallycustomfilterbutton",context:this.getContext(),modelNames:types,stateful:!0,stateId:this.getContext().getScopedStateId("filters"),listeners:{customfilter:this._onFilterButtonStateAvailable,scope:this},toolTipConfig:{html:"Filter",anchor:"top",mouseOffset:[-9,-2]}},{xtype:"component",flex:1},{xtype:"rallycombobox",itemId:"chartType",fieldLabel:"Chart Type:",labelAlign:"Left",displayField:"name",valueField:"value",editable:!1,stateful:!0,labelWidth:60,stateId:this.getContext().getScopedStateId("chartType"),store:Ext.create("Ext.data.Store",{fields:["name","value"],data:[{name:"Pie",value:"pie"},{name:"Bar",value:"bar"}]}),applyState:function(state){Rally.ui.combobox.ComboBox.superclass.applyState.call(this,state)},listeners:{select:function(combo,records){this._createChartConfigSection(combo,records)},scope:this}}]},{xtype:"container",itemId:"chart_config_box",flex:1,layout:"fit"}])},_getTypes:function(){return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",sorters:[{property:"Name"}],fetch:["DisplayName","ElementName","TypePath","Parent"],filters:[{property:"Creatable",value:!0}],remoteSort:!1,remoteFilter:!0}).load().then({success:function(records){var types=_.filter(records,function(record){var parent=record.get("Parent"),parentName=parent.ElementName;return _.contains(["Artifact","SchedulableArtifact","Requirement","PortfolioItem"],parentName)}),displayNames=_.map(types,function(type){return type.get("TypePath")});return displayNames.sort(),displayNames}})},_onFilterButtonStateAvailable:function(){this._createChart(this.down("#chartType").getValue())},_createChartConfigSection:function(comboBox,selectedValue){this.down("#chart_config_box").removeAll(),delete this.chart;var selectedChartType=selectedValue[0].get("name");this._createChart(selectedChartType)},_createChart:function(type){var filterButton=this.down("rallycustomfilterbutton"),config={types:filterButton.getTypes(),filters:filterButton.getFilters()};this.chart?this.chart.refresh(config):this.chart=this.down("#chart_config_box").add(Ext.apply({xtype:type+"chart",context:this.getContext()},config))}});

            Rally.launchApp('CustomApp', {
                name:"RallyChartGenerator",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
